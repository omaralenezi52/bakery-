{% extends "base.html" %}
{% block title %}{{ product['title'] }} â€” Ø­Ù„ÙˆÙŠØ§Øª Ù„Ù…Ø³Ø©{% endblock %}

{% block content %}
<div class="product-detail-page">
    
    <!-- Breadcrumb -->
    <div class="breadcrumb">
        <a href="{{ url_for('index') }}">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <span>â€º</span>
        <a href="{{ url_for('category', cat=product['category']) }}">{{ product['category'] }}</a>
        <span>â€º</span>
        <span>{{ product['title'] }}</span>
    </div>

    <!-- Product Main -->
    <div class="product-main">
        <div class="product-gallery">
            <div class="product-img-main">
                <img src="{{ product['image_url'] }}" alt="{{ product['title'] }}" id="mainImg">
                {% if product['badge'] %}
                <span class="product-badge-large">{{ product['badge'] }}</span>
                {% endif %}
            </div>
            <div class="product-img-thumbs">
                <div class="thumb active" onclick="changeImg(this, '{{ product['image_url'] }}')">
                    <img src="{{ product['image_url'] }}" alt="">
                </div>
            </div>
        </div>

        <div class="product-info-panel">
            <span class="product-category-tag">{{ product['category'] }}</span>
            <h1 class="product-name">{{ product['title'] }}</h1>
            
            <!-- Rating Stars -->
            <div class="product-rating">
                <div class="stars">â­â­â­â­â­</div>
                <span class="rating-text">{{ total_sold }} ÙˆØ­Ø¯Ø© Ù…Ø¨Ø§Ø¹Ø© Â· {{ orders }} Ø·Ù„Ø¨</span>
            </div>

            <p class="product-description">{{ product['description'] }}</p>

            <!-- Price Block -->
            <div class="product-price-block">
                <span class="product-price-main">{{ product['price'] }}</span>
                <span class="product-price-currency">Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ</span>
            </div>

            <!-- Quantity Selector -->
            <div class="quantity-block">
                <label>Ø§Ù„ÙƒÙ…ÙŠØ©:</label>
                <div class="qty-selector">
                    <button onclick="changeQty(-1)">âˆ’</button>
                    <span id="qtyDisplay">1</span>
                    <button onclick="changeQty(1)">+</button>
                </div>
                <span class="qty-total" id="qtyTotal">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <strong>{{ product['price'] }} Ø±ÙŠØ§Ù„</strong></span>
            </div>

            <!-- CTA Buttons -->
            <div class="product-cta">
                <button class="btn-buy-now" onclick="buyNow({{ product['id'] }}, '{{ product['title'] }}', {{ product['price'] }}, '{{ product['image_url'] }}')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/></svg>
                    Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©
                </button>
                <button class="btn-wishlist" title="Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙØ¶Ù„Ø©">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                </button>
            </div>

            <!-- Delivery Info -->
            <div class="delivery-info">
                <div class="delivery-item">
                    <span>ğŸš€</span>
                    <div>
                        <strong>ØªÙˆØµÙŠÙ„ Ø®Ù„Ø§Ù„ Ø³Ø§Ø¹ØªÙŠÙ†</strong>
                        <small>Ø§Ù„Ø±ÙŠØ§Ø¶ ÙˆØ¶ÙˆØ§Ø­ÙŠÙ‡Ø§</small>
                    </div>
                </div>
                <div class="delivery-item">
                    <span>ğŸ</span>
                    <div>
                        <strong>ØªØºÙ„ÙŠÙ Ù‡Ø¯ÙŠØ© Ù…Ø¬Ø§Ù†Ø§Ù‹</strong>
                        <small>Ù…Ø¹ Ø¨Ø·Ø§Ù‚Ø© ØªÙ‡Ù†Ø¦Ø© Ù…Ø®ØµØµØ©</small>
                    </div>
                </div>
                <div class="delivery-item">
                    <span>âœ…</span>
                    <div>
                        <strong>Ø¶Ù…Ø§Ù† Ø§Ù„Ø¬ÙˆØ¯Ø©</strong>
                        <small>Ø£Ùˆ Ø§Ø³ØªØ±Ø¯Ø§Ø¯ ÙƒØ§Ù…Ù„</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Related Products -->
    {% if related %}
    <section class="related-section">
        <div class="section-header">
            <span class="section-tag">Ù…Ù‚ØªØ±Ø­Ø§Øª</span>
            <h2 class="section-title">Ù‚Ø¯ ÙŠØ¹Ø¬Ø¨Ùƒ Ø£ÙŠØ¶Ø§Ù‹</h2>
        </div>
        <div class="related-grid">
            {% for item in related %}
            <a href="{{ url_for('product_detail', product_id=item['id']) }}" class="related-card">
                <div class="related-img">
                    <img src="{{ item['image_url'] }}" alt="{{ item['title'] }}">
                </div>
                <div class="related-info">
                    <h4>{{ item['title'] }}</h4>
                    <span>{{ item['price'] }} Ø±ÙŠØ§Ù„</span>
                </div>
            </a>
            {% endfor %}
        </div>
    </section>
    {% endif %}

</div>

{% endblock %}

{% block scripts %}
<script>
let currentQty = 1;
const basePrice = {{ product['price'] }};
const productId = {{ product['id'] }};
const productTitle = "{{ product['title'] }}";
const productImg = "{{ product['image_url'] }}";

function changeQty(delta) {
    currentQty = Math.max(1, currentQty + delta);
    document.getElementById('qtyDisplay').textContent = currentQty;
    document.getElementById('qtyTotal').innerHTML = `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <strong>${(basePrice * currentQty).toFixed(2)} Ø±ÙŠØ§Ù„</strong>`;
}

function changeImg(el, src) {
    document.getElementById('mainImg').src = src;
    document.querySelectorAll('.thumb').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
}

function buyNow(id, title, price, img) {
    for (let i = 0; i < currentQty; i++) {
        addToCart(id, title, price, img);
    }
    // Register sale
    fetch(`/api/buy/${id}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({quantity: currentQty})
    });
    toggleCart();
}
</script>
{% endblock %}